name: Enhanced Prompt Service CI

on:
  push:
    branches: [ main, develop ]
    paths: 
      - 'enhanced_prompt_service/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'enhanced_prompt_service/**'

env:
  PYTHON_VERSION: '3.11'
  SERVICE_PATH: enhanced_prompt_service

jobs:
  dependency-validation:
    name: ğŸ” Dependency Validation
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.SERVICE_PATH }}
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ğŸ” Validate pinned dependencies
        run: |
          echo "Checking that all dependencies are properly pinned..."
          python scripts/validate_requirements.py
      
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ğŸ” Audit dependencies for vulnerabilities
        run: |
          echo "Running security audit on installed dependencies..."
          python scripts/audit_dependencies.py
      
      - name: ğŸ“Š Generate dependency report
        if: always()
        run: |
          echo "=== Installed Packages ===" > dependency-report.txt
          pip list >> dependency-report.txt
          echo "" >> dependency-report.txt
          echo "=== Dependency Tree ===" >> dependency-report.txt
          pip install pipdeptree
          pipdeptree >> dependency-report.txt
      
      - name: ğŸ“¤ Upload dependency report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-report
          path: ${{ env.SERVICE_PATH }}/dependency-report.txt
          retention-days: 30

  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: dependency-validation
    defaults:
      run:
        working-directory: ${{ env.SERVICE_PATH }}
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ğŸ” Run Bandit security scan
        run: |
          pip install bandit[toml]
          bandit -r . -f json -o bandit-report.json || true
      
      - name: ğŸ” Run Safety security scan
        run: |
          pip install safety
          safety check --json --output safety-report.json || true
      
      - name: ğŸ“¤ Upload security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            ${{ env.SERVICE_PATH }}/bandit-report.json
            ${{ env.SERVICE_PATH }}/safety-report.json
          retention-days: 30

  documentation-validation:
    name: ğŸ“š Documentation Validation
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.SERVICE_PATH }}
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: ğŸ“¦ Install markdown-link-check
        run: npm install -g markdown-link-check
      
      - name: ğŸ” Check README links
        run: |
          markdown-link-check README.md --quiet || echo "README link check failed"
      
      - name: ğŸ” Check documentation links
        run: |
          find docs -name "*.md" -print0 | xargs -0 -I {} \
          markdown-link-check {} --quiet || echo "Documentation link check failed"
      
      - name: âœ… Validate OpenAPI spec exists
        run: |
          if [ ! -f "docs/enhanced_prompt_openapi.json" ]; then
            echo "âŒ OpenAPI specification file not found"
            exit 1
          fi
          echo "âœ… OpenAPI specification file exists"
      
      - name: ğŸ” Validate OpenAPI spec format
        run: |
          python -c "
          import json
          try:
              with open('docs/enhanced_prompt_openapi.json', 'r') as f:
                  spec = json.load(f)
              assert 'openapi' in spec, 'Missing openapi version'
              assert 'info' in spec, 'Missing info section'
              assert 'paths' in spec, 'Missing paths section'
              print('âœ… OpenAPI specification is valid JSON with required fields')
          except Exception as e:
              print(f'âŒ OpenAPI specification validation failed: {e}')
              exit(1)
          "
  test:
    name: ğŸ§ª Test
    runs-on: ubuntu-latest
    needs: [dependency-validation, documentation-validation]
    defaults:
      run:
        working-directory: ${{ env.SERVICE_PATH }}
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov pytest-mock httpx fakeredis
      
      - name: ğŸ§ª Run Python Tests
        run: |
          pytest --maxfail=1 --disable-warnings -q
      
      - name: ğŸ§ª Run tests with coverage
        run: |
          python -m pytest tests/ -v --cov=. --cov-report=xml --cov-report=term-missing --cov-report=html
      
      - name: ğŸ§ª Run integration tests
        run: |
          python -m pytest tests/test_clip_store.py -v -k "integration" --disable-warnings
      
      - name: ğŸ§ª Run E2E API tests
        run: |
          python -m pytest tests/test_api_endpoints.py -v --disable-warnings
      
      - name: ğŸ“Š Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ${{ env.SERVICE_PATH }}/coverage.xml
          flags: enhanced-prompt-service
          name: enhanced-prompt-service
      
      - name: ğŸ“¤ Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            ${{ env.SERVICE_PATH }}/coverage.xml
            ${{ env.SERVICE_PATH }}/htmlcov/
          retention-days: 30
      
      - name: ğŸ“¤ Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: ${{ env.SERVICE_PATH }}/pytest-results.xml
          retention-days: 30
