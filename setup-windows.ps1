# Surveillance System - Windows Kurulum Scripti
# Bu script surveillance system projesini Windows ortamÄ±nda kurar ve yapÄ±landÄ±rÄ±r

param(
    [switch]$SkipPrerequisites,
    [switch]$DevMode,
    [switch]$Quick,
    [switch]$BuildOnly,
    [string]$Environment = "development"
)

# Renkli Ã§Ä±ktÄ± iÃ§in fonksiyonlar
function Write-ColorOutput($ForegroundColor) {
    if ($Host.UI.RawUI.ForegroundColor) {
        $fc = $Host.UI.RawUI.ForegroundColor
        $Host.UI.RawUI.ForegroundColor = $ForegroundColor
        if ($args) {
            Write-Output $args
        } else {
            $input | Write-Output
        }
        $Host.UI.RawUI.ForegroundColor = $fc
    } else {
        if ($args) {
            Write-Output $args
        } else {
            $input | Write-Output
        }
    }
}

function Write-Success { Write-ColorOutput Green $args }
function Write-Warning { Write-ColorOutput Yellow $args }
function Write-Error { Write-ColorOutput Red $args }
function Write-Info { Write-ColorOutput Cyan $args }

# Ana baÅŸlÄ±k
Write-Host @"
ğŸš€ Surveillance System - Windows Kurulum Scripti
================================================
Ortam: $Environment
"@ -ForegroundColor Magenta

# Hata yÃ¶netimi
$ErrorActionPreference = "Stop"
trap {
    Write-Error "âŒ Hata oluÅŸtu: $_"
    Read-Host "Devam etmek iÃ§in Enter'a basÄ±n"
    exit 1
}

# Gerekli Ã¶n koÅŸullarÄ± kontrol et
function Test-Prerequisites {
    if ($SkipPrerequisites) {
        Write-Warning "âš ï¸  Ã–n koÅŸul kontrolleri atlanÄ±yor..."
        return
    }

    Write-Info "ğŸ“‹ Ã–n koÅŸullar kontrol ediliyor..."
    
    # Docker kontrolÃ¼
    try {
        $dockerVersion = docker --version
        Write-Success "âœ… Docker bulundu: $dockerVersion"
    }
    catch {
        Write-Error "âŒ Docker bulunamadÄ±. LÃ¼tfen Docker Desktop'Ä± kurun: https://www.docker.com/products/docker-desktop"
        exit 1
    }

    # Docker Compose kontrolÃ¼
    try {
        $composeVersion = docker-compose --version
        Write-Success "âœ… Docker Compose bulundu: $composeVersion"
    }
    catch {
        Write-Error "âŒ Docker Compose bulunamadÄ±. Docker Desktop ile birlikte gelmelidir."
        exit 1
    }

    # Python kontrolÃ¼
    try {
        $pythonVersion = python --version
        Write-Success "âœ… Python bulundu: $pythonVersion"
    }
    catch {
        Write-Warning "âš ï¸  Python bulunamadÄ±. BazÄ± geliÅŸtirme araÃ§larÄ± Ã§alÄ±ÅŸmayabilir."
    }

    # Git kontrolÃ¼
    try {
        $gitVersion = git --version
        Write-Success "âœ… Git bulundu: $gitVersion"
    }
    catch {
        Write-Warning "âš ï¸  Git bulunamadÄ±. Versiyon kontrolÃ¼ iÃ§in Git kurmanÄ±z Ã¶nerilir."
    }

    # Docker'Ä±n Ã§alÄ±ÅŸÄ±r durumda olduÄŸunu kontrol et
    try {
        docker ps | Out-Null
        Write-Success "âœ… Docker servisi Ã§alÄ±ÅŸÄ±yor"
    }
    catch {
        Write-Error "âŒ Docker servisi Ã§alÄ±ÅŸmÄ±yor. LÃ¼tfen Docker Desktop'Ä± baÅŸlatÄ±n."
        exit 1
    }
}

# Ortam deÄŸiÅŸkenlerini ayarla
function Set-EnvironmentVariables {
    Write-Info "ğŸ”§ Ortam deÄŸiÅŸkenleri ayarlanÄ±yor..."
    
    # .env dosyasÄ± oluÅŸtur
    $envContent = @"
# Surveillance System Environment Configuration
# Generated by setup script on $(Get-Date)

# Environment
ENVIRONMENT=$Environment

# Database Configuration
POSTGRES_DB=events_db
POSTGRES_USER=surveillance_user
POSTGRES_PASSWORD=surveillance_pass_$(Get-Random -Minimum 1000 -Maximum 9999)
DATABASE_URL=postgresql://surveillance_user:surveillance_pass_$(Get-Random -Minimum 1000 -Maximum 9999)@postgres:5432/events_db

# Redis Configuration
REDIS_URL=redis://redis:6379/0

# Kafka Configuration
KAFKA_BOOTSTRAP_SERVERS=kafka:9092
KAFKA_TOPIC_PREFIX=surveillance

# API Configuration
API_HOST=0.0.0.0
API_PORT=8000
JWT_SECRET_KEY=surveillance_jwt_secret_$(Get-Random -Minimum 10000 -Maximum 99999)

# AI Service Configuration
OPENAI_API_KEY=your_openai_api_key_here
WEAVIATE_URL=http://weaviate:8080

# Monitoring
PROMETHEUS_PORT=9090
GRAFANA_PORT=3000
GRAFANA_ADMIN_PASSWORD=admin123

# Video Storage
VIDEO_STORAGE_PATH=./data/clips
MAX_CLIP_SIZE_MB=100

# MQTT Configuration
MQTT_BROKER_HOST=localhost
MQTT_BROKER_PORT=1883
MQTT_USERNAME=surveillance
MQTT_PASSWORD=mqtt_pass_$(Get-Random -Minimum 1000 -Maximum 9999)

# Development Settings
DEBUG=true
LOG_LEVEL=INFO
"@

    $envContent | Out-File -FilePath ".env" -Encoding UTF8
    Write-Success "âœ… .env dosyasÄ± oluÅŸturuldu"
}

# Gerekli dizinleri oluÅŸtur
function New-RequiredDirectories {
    Write-Info "ğŸ“ Gerekli dizinler oluÅŸturuluyor..."
    
    $directories = @(
        "data",
        "data/clips",
        "data/postgres",
        "data/redis",
        "logs",
        "certs",
        "monitoring/grafana/data",
        "monitoring/prometheus/data"
    )
    
    foreach ($dir in $directories) {
        if (!(Test-Path $dir)) {
            New-Item -ItemType Directory -Path $dir -Force | Out-Null
            Write-Success "âœ… Dizin oluÅŸturuldu: $dir"
        }
    }
}

# Docker volumelerini oluÅŸtur
function New-DockerVolumes {
    Write-Info "ğŸ’¾ Docker volumeleri oluÅŸturuluyor..."
    
    $volumes = @(
        "surveillance_postgres_data",
        "surveillance_redis_data",
        "surveillance_kafka_data",
        "surveillance_weaviate_data",
        "surveillance_grafana_data",
        "surveillance_prometheus_data"
    )
    
    foreach ($volume in $volumes) {
        try {
            docker volume create $volume | Out-Null
            Write-Success "âœ… Volume oluÅŸturuldu: $volume"
        }
        catch {
            Write-Warning "âš ï¸  Volume zaten mevcut veya oluÅŸturulamadÄ±: $volume"
        }
    }
}

# Docker networklerini oluÅŸtur
function New-DockerNetworks {
    Write-Info "ğŸŒ Docker networkleri oluÅŸturuluyor..."
    
    $networks = @(
        "surveillance_network",
        "surveillance_monitoring"
    )
    
    foreach ($network in $networks) {
        try {
            docker network create $network | Out-Null
            Write-Success "âœ… Network oluÅŸturuldu: $network"
        }
        catch {
            Write-Warning "âš ï¸  Network zaten mevcut veya oluÅŸturulamadÄ±: $network"
        }
    }
}

# Docker imajlarÄ±nÄ± build et
function Build-DockerImages {
    Write-Info "ğŸ³ Docker imajlarÄ± build ediliyor..."
    
    $services = @(
        "api_gateway",
        "edge_service", 
        "vms_service",
        "ingest_service",
        "prompt_service",
        "enhanced_prompt_service",
        "rag_service",
        "advanced_rag_service",
        "rule_builder_service",
        "rulegen_service",
        "notifier",
        "mqtt_kafka_bridge",
        "websocket_service",
        "voice_interface_service",
        "ai_dashboard_service",
        "agent_orchestrator"
    )
    
    foreach ($service in $services) {
        if (Test-Path "$service/Dockerfile") {
            Write-Info "ğŸ—ï¸  Building $service..."
            try {
                docker build -t "surveillance-$service" -f "$service/Dockerfile" .
                Write-Success "âœ… $service build edildi"
            }
            catch {
                Write-Warning "âš ï¸  $service build edilemedi: $_"
            }
        }
    }
}

# Servisleri baÅŸlat
function Start-Services {
    Write-Info "ğŸš€ Servisler baÅŸlatÄ±lÄ±yor..."
    
    if ($Quick) {
        Write-Info "âš¡ HÄ±zlÄ± baÅŸlatma modu - sadece temel servisler"
        docker-compose up -d postgres redis kafka zookeeper api_gateway
    }
    elseif ($DevMode) {
        Write-Info "ğŸ› ï¸  GeliÅŸtirme modu - monitoring servisleri dahil"
        docker-compose --profile development up -d
    }
    else {
        Write-Info "ğŸŒŸ TÃ¼m servisler baÅŸlatÄ±lÄ±yor..."
        docker-compose up -d
    }
    
    Write-Success "âœ… Servisler baÅŸlatÄ±ldÄ±"
}

# Health check
function Test-ServiceHealth {
    Write-Info "ğŸ¥ Servis saÄŸlÄ±ÄŸÄ± kontrol ediliyor..."
    
    Start-Sleep -Seconds 10
    
    $services = @(
        @{Name="API Gateway"; Url="http://localhost:8000/health"},
        @{Name="Postgres"; Command="docker exec surveillance-postgres pg_isready -U surveillance_user"},
        @{Name="Redis"; Command="docker exec surveillance-redis redis-cli ping"}
    )
    
    foreach ($service in $services) {
        if ($service.Url) {
            try {
                $response = Invoke-WebRequest -Uri $service.Url -TimeoutSec 5
                if ($response.StatusCode -eq 200) {
                    Write-Success "âœ… $($service.Name) saÄŸlÄ±klÄ±"
                }
            }
            catch {
                Write-Warning "âš ï¸  $($service.Name) henÃ¼z hazÄ±r deÄŸil"
            }
        }
        elseif ($service.Command) {
            try {
                Invoke-Expression $service.Command | Out-Null
                Write-Success "âœ… $($service.Name) saÄŸlÄ±klÄ±"
            }
            catch {
                Write-Warning "âš ï¸  $($service.Name) henÃ¼z hazÄ±r deÄŸil"
            }
        }
    }
}

# GeliÅŸtirme araÃ§larÄ±nÄ± kur
function Install-DevelopmentTools {
    if (!$DevMode) {
        return
    }
    
    Write-Info "ğŸ› ï¸  GeliÅŸtirme araÃ§larÄ± kuruluyor..."
    
    # Python sanal ortamÄ± oluÅŸtur
    if (Get-Command python -ErrorAction SilentlyContinue) {
        try {
            python -m venv venv
            Write-Success "âœ… Python sanal ortamÄ± oluÅŸturuldu"
            
            # Sanal ortamÄ± aktif et ve gereksinimleri kur
            & .\venv\Scripts\Activate.ps1
            
            if (Test-Path "requirements.txt") {
                pip install -r requirements.txt
                Write-Success "âœ… Python gereksinimleri kuruldu"
            }
            
            # GeliÅŸtirme gereksinimleri
            pip install pytest black flake8 mypy pre-commit
            Write-Success "âœ… GeliÅŸtirme araÃ§larÄ± kuruldu"
            
        }
        catch {
            Write-Warning "âš ï¸  Python geliÅŸtirme araÃ§larÄ± kurulamadÄ±: $_"
        }
    }
}

# Ana kurulum fonksiyonu
function Install-SurveillanceSystem {
    Write-Host "ğŸ¯ Kurulum baÅŸlÄ±yor..." -ForegroundColor Green
    
    # Ã–n koÅŸullarÄ± kontrol et
    Test-Prerequisites
    
    # Ortam deÄŸiÅŸkenlerini ayarla
    Set-EnvironmentVariables
    
    # Gerekli dizinleri oluÅŸtur
    New-RequiredDirectories
    
    # Docker kaynaklarÄ±nÄ± oluÅŸtur
    New-DockerVolumes
    New-DockerNetworks
    
    if (!$BuildOnly) {
        # Ä°majlarÄ± build et
        Build-DockerImages
        
        # Servisleri baÅŸlat
        Start-Services
        
        # SaÄŸlÄ±k kontrolÃ¼
        Test-ServiceHealth
        
        # GeliÅŸtirme araÃ§larÄ±nÄ± kur
        Install-DevelopmentTools
    }
    else {
        Build-DockerImages
    }
    
    Write-Host @"

ğŸ‰ Kurulum tamamlandÄ±!
===================

Servis URL'leri:
â€¢ API Gateway: http://localhost:8000
â€¢ Grafana Monitoring: http://localhost:3000 (admin/admin123)
â€¢ Prometheus: http://localhost:9090

KullanÄ±ÅŸlÄ± komutlar:
â€¢ Servisleri durdur: docker-compose down
â€¢ Servisleri yeniden baÅŸlat: docker-compose restart
â€¢ LoglarÄ± gÃ¶rÃ¼ntÃ¼le: docker-compose logs -f
â€¢ Durumu kontrol et: .\check-status.ps1

GeliÅŸtirme:
â€¢ Python sanal ortamÄ±: .\venv\Scripts\Activate.ps1
â€¢ Testleri Ã§alÄ±ÅŸtÄ±r: pytest
â€¢ Kodu formatla: black .

Daha fazla bilgi iÃ§in README.md dosyasÄ±nÄ± inceleyin.
"@ -ForegroundColor Green
}

# Cleanup fonksiyonu
function Remove-SurveillanceSystem {
    Write-Warning "ğŸ§¹ Sistem temizleniyor..."
    
    # Servisleri durdur
    docker-compose down -v
    
    # Ä°majlarÄ± sil
    docker images -q surveillance-* | ForEach-Object { docker rmi $_ -f }
    
    # Volumeleri sil
    docker volume ls -q | Where-Object { $_ -like "surveillance_*" } | ForEach-Object { docker volume rm $_ }
    
    # Networkleri sil
    docker network ls -q | Where-Object { $_ -like "surveillance_*" } | ForEach-Object { docker network rm $_ }
    
    Write-Success "âœ… Temizlik tamamlandÄ±"
}

# Ana script logic
if ($args -contains "clean") {
    Remove-SurveillanceSystem
}
else {
    Install-SurveillanceSystem
}

Write-Host "`nğŸš€ Script tamamlandÄ±!" -ForegroundColor Magenta
